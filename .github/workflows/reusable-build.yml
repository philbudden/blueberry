---
name: Reusable Build Workflow
on:
  workflow_call:
    inputs:
      fedora_version:
        description: "Fedora IoT version to build from"
        required: true
        type: string

env:
  IMAGE_REGISTRY: ghcr.io/${{ github.repository_owner }}

jobs:
  build-info:
    name: Get Build Info
    runs-on: ubuntu-24.04
    outputs:
      fedora_version: ${{ steps.build-info.outputs.fedora_version }}
      pr_prefix: ${{ steps.build-info.outputs.pr_prefix }}
      image_version: ${{ steps.build-info.outputs.image_version }}
    steps:
      - name: Set PR prefix
        id: build-info
        shell: bash
        run: |
          set -euo pipefail

          # Set Fedora version
          echo "fedora_version=${{ inputs.fedora_version }}" >> "$GITHUB_OUTPUT"

          # Set PR prefix for PR builds
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            PR_PREFIX="pr-${{ github.event.number }}-"
          else
            PR_PREFIX=""
          fi
          echo "pr_prefix=${PR_PREFIX}" >> "$GITHUB_OUTPUT"

          # Get base image version from quay.io
          FEDORA_VER="${{ inputs.fedora_version }}"
          IMAGE_VERSION=$(skopeo inspect \
            docker://quay.io/fedora/fedora-iot:"${FEDORA_VER}"-aarch64 | \
            jq -r '.Labels.version')
          echo "image_version=${IMAGE_VERSION}" >> "$GITHUB_OUTPUT"

          echo "Fedora IoT version: ${IMAGE_VERSION}"

  build-images:
    name: Build Images
    runs-on: ubuntu-24.04-arm
    needs: build-info
    permissions:
      contents: read
      packages: write
      id-token: write
    strategy:
      max-parallel: 1  # Build sequentially to ensure blueberry-minimal completes before blueberry
      fail-fast: false
      matrix:
        image_name:
          - blueberry-minimal
          - blueberry
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Set up environment variables
        id: env
        run: |
          set -euo pipefail

          # Lowercase the registry and image name
          IMAGE_NAME=$(echo "${{ matrix.image_name }}" | tr '[:upper:]' '[:lower:]')
          echo "image_name=${IMAGE_NAME}" >> "$GITHUB_OUTPUT"

          # Set build date
          BUILD_DATE=$(date -u +%Y%m%d)
          echo "build_date=${BUILD_DATE}" >> "$GITHUB_OUTPUT"

          # Set short SHA
          if [[ -z "$(git status -s)" ]]; then
            SHA_SHORT=$(git rev-parse --short HEAD)
          else
            SHA_SHORT="dirty"
          fi
          echo "sha_short=${SHA_SHORT}" >> "$GITHUB_OUTPUT"

      - name: Pull base images
        uses: Wandalen/wretry.action@6feedb7dedadeb826de0f45ff482b53b379a7844 # v3.5.0
        with:
          attempt_limit: 3
          attempt_delay: 15000
          command: |
            # Pull Fedora IoT base (always needed for blueberry-minimal)
            FEDORA_VER="${{ needs.build-info.outputs.fedora_version }}"
            sudo podman pull quay.io/fedora/fedora-iot:"${FEDORA_VER}"-aarch64

            # For blueberry build, also pull blueberry-minimal if exists
            # This allows rebuilding blueberry without rebuilding minimal
            if [[ "${{ matrix.image_name }}" == "blueberry" ]]; then
              REGISTRY="${{ env.IMAGE_REGISTRY }}"
              sudo podman pull "${REGISTRY}/blueberry-minimal:${FEDORA_VER}" || true
            fi

      - name: Build image
        id: build
        uses: redhat-actions/buildah-build@7a95fa7ee0f02d552a32753e7414641a04307056 # v2
        with:
          containerfiles: |
            ./${{ matrix.image_name }}/Containerfile
          context: ./${{ matrix.image_name }}
          image: ${{ steps.env.outputs.image_name }}
          tags: |
            ${{ needs.build-info.outputs.pr_prefix }}${{ steps.env.outputs.sha_short }}
            ${{ steps.env.outputs.build_date }}
            ${{ needs.build-info.outputs.fedora_version }}
            latest
          build-args: |
            FEDORA_VERSION=${{ needs.build-info.outputs.fedora_version }}
            ARCH=aarch64
          labels: |
            org.opencontainers.image.title=${{ matrix.image_name }}
            org.opencontainers.image.version=${{ needs.build-info.outputs.image_version }}
            org.opencontainers.image.description=Fedora IoT-based image for aarch64 SBCs
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ steps.env.outputs.build_date }}
            containers.bootc=1
          oci: false

      - name: List available images (debug)
        if: matrix.image_name == 'blueberry-minimal'
        run: |
          echo "=== Listing all images ==="
          sudo buildah images
          echo "=== Build outputs ==="
          echo "Image: ${{ steps.build.outputs.image }}"
          echo "Tags: ${{ steps.build.outputs.tags }}"

      - name: Tag image with registry prefix for local use
        if: matrix.image_name == 'blueberry-minimal'
        run: |
          # Tag blueberry-minimal with GHCR path so blueberry Containerfile finds it locally
          # When Containerfile does FROM ghcr.io/.../blueberry-minimal:44, buildah checks
          # local storage first before trying to pull, so this will be used
          IMG="${{ steps.env.outputs.image_name }}"
          REGISTRY="${{ env.IMAGE_REGISTRY }}"
          FEDORA_VER="${{ needs.build-info.outputs.fedora_version }}"
          sudo buildah tag "${IMG}:latest" "${REGISTRY}/${IMG}:${FEDORA_VER}"

      - name: Push image to GHCR
        id: push
        if: |
          github.event_name != 'pull_request' &&
          github.ref == format('refs/heads/{0}', github.event.repository.default_branch)
        uses: redhat-actions/push-to-registry@5ed88d269cf581ea9ef6dd6806d01562096bee9c # v2
        with:
          registry: ${{ env.IMAGE_REGISTRY }}
          image: ${{ steps.env.outputs.image_name }}
          tags: |
            ${{ steps.env.outputs.build_date }}
            ${{ needs.build-info.outputs.fedora_version }}
            latest
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to GHCR for signing
        if: |
          github.event_name != 'pull_request' &&
          github.ref == format('refs/heads/{0}', github.event.repository.default_branch)
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install cosign
        if: |
          github.event_name != 'pull_request' &&
          github.ref == format('refs/heads/{0}', github.event.repository.default_branch)
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Sign container image
        if: |
          github.event_name != 'pull_request' &&
          github.ref == format('refs/heads/{0}', github.event.repository.default_branch)
        run: |
          set -euo pipefail

          # Sign using digest from push step output
          IMG="${{ steps.env.outputs.image_name }}"
          REGISTRY="${{ env.IMAGE_REGISTRY }}"
          DIGEST="${{ steps.push.outputs.digest }}"
          cosign sign -y --key env://COSIGN_PRIVATE_KEY "${REGISTRY}/${IMG}@${DIGEST}"
        env:
          COSIGN_EXPERIMENTAL: false
          COSIGN_PRIVATE_KEY: ${{ secrets.SIGNING_SECRET }}
