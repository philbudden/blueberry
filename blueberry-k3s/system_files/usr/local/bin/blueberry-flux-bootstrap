#!/bin/bash
# blueberry-flux-bootstrap - Bootstrap FluxCD on K3s cluster
# This script initializes FluxCD GitOps automation on an active K3s cluster

set -euo pipefail

# Set K3s kubeconfig path
# K3s stores kubeconfig at /etc/rancher/k3s/k3s.yaml (requires root access)
export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

# Usage information
usage() {
	cat <<EOF
Usage: blueberry-flux-bootstrap <git-provider> [options]

Git Providers:
  github              Bootstrap using GitHub repository
  gitlab              Bootstrap using GitLab repository (not yet implemented)
  generic             Bootstrap using generic git repository (not yet implemented)

GitHub Options:
  --owner <owner>     GitHub repository owner (required)
  --repository <repo> GitHub repository name (required)
  --path <path>       Path within repo for manifests (default: clusters/blueberry)
  --personal          Use personal GitHub account (default: false)
  --token-file <file> Path to GitHub token file (default: ~/.github-token)

Examples:
  # Bootstrap with GitHub
  blueberry-flux-bootstrap github --owner myorg --repository fleet-infra

  # Bootstrap with token from file
  blueberry-flux-bootstrap github --owner myorg --repository fleet-infra --token-file /var/secrets/github-token

Requirements:
  - K3s server must be running (ujust k3s-init-server)
  - GitHub personal access token with 'repo' scope saved to token file
  - Network connectivity to GitHub

EOF
	exit 1
}

# Verify K3s is running
if ! systemctl is-active k3s-server.service &>/dev/null; then
	echo "Error: K3s server is not running."
	echo ""
	echo "FluxCD requires an active K3s cluster."
	echo "Initialize K3s first:"
	echo "  ujust k3s-init-server"
	exit 1
fi

# Verify kubectl works
if ! kubectl get nodes &>/dev/null; then
	echo "Error: Cannot communicate with K3s cluster."
	echo "Check K3s status: ujust k3s-status"
	exit 1
fi

# Parse arguments
PROVIDER=""
OWNER=""
REPO=""
FLUX_PATH="clusters/blueberry"
PERSONAL=false
TOKEN_FILE="$HOME/.github-token"

if [[ $# -eq 0 ]]; then
	usage
fi

PROVIDER=$1
shift

while [[ $# -gt 0 ]]; do
	case $1 in
	--owner)
		OWNER="$2"
		shift 2
		;;
	--repository)
		REPO="$2"
		shift 2
		;;
	--path)
		FLUX_PATH="$2"
		shift 2
		;;
	--personal)
		PERSONAL=true
		shift
		;;
	--token-file)
		TOKEN_FILE="$2"
		shift 2
		;;
	*)
		echo "Unknown option: $1"
		usage
		;;
	esac
done

# Validate provider
if [[ "$PROVIDER" != "github" && "$PROVIDER" != "gitlab" && "$PROVIDER" != "generic" ]]; then
	echo "Error: Invalid provider '$PROVIDER'."
	usage
fi

# Validate GitHub requirements
if [[ "$PROVIDER" == "github" ]]; then
	if [[ -z "$OWNER" || -z "$REPO" ]]; then
		echo "Error: GitHub provider requires --owner and --repository."
		usage
	fi

	if [[ ! -f "$TOKEN_FILE" ]]; then
		echo "Error: GitHub token file not found: $TOKEN_FILE"
		echo ""
		echo "Create a GitHub personal access token with 'repo' scope and save to:"
		echo "  $TOKEN_FILE"
		echo ""
		echo "Example:"
		echo "  echo 'ghp_your_token_here' > ~/.github-token"
		echo "  chmod 600 ~/.github-token"
		echo ""
		echo "NOTE: If running via 'ujust', the file must be readable by root."
		echo "Consider placing the token in a root-accessible location:"
		echo "  sudo mkdir -p /etc/blueberry-k3s/secrets"
		echo "  echo 'ghp_your_token_here' | sudo tee /etc/blueberry-k3s/secrets/github-token"
		echo "  sudo chmod 600 /etc/blueberry-k3s/secrets/github-token"
		exit 1
	fi
	
	# Verify token file is readable (important when run via sudo)
	if [[ ! -r "$TOKEN_FILE" ]]; then
		echo "Error: Cannot read token file: $TOKEN_FILE"
		echo ""
		echo "The file exists but is not readable by the current user."
		echo "If running via sudo, ensure the file is root-readable."
		exit 1
	fi
fi

# Check for existing Flux installation
if flux check &>/dev/null; then
	echo "Error: FluxCD is already installed on this cluster."
	echo ""
	echo "To reinstall, first uninstall Flux:"
	echo "  flux uninstall"
	exit 1
fi

# Display Flux version
echo "╔════════════════════════════════════════════════╗"
echo "║  FluxCD Bootstrap                              ║"
echo "╚════════════════════════════════════════════════╝"
echo ""
FLUX_VERSION=$(cat /etc/blueberry-k3s/flux-version)
echo "FluxCD CLI version: $FLUX_VERSION"
echo "Provider: $PROVIDER"
if [[ "$PROVIDER" == "github" ]]; then
	echo "Repository: $OWNER/$REPO"
	echo "Path: $FLUX_PATH"
fi
echo ""

# Pre-flight checks
echo "Running pre-flight checks..."
flux check --pre

echo ""
echo "Press Ctrl+C to abort, or Enter to continue..."
read -r

# Bootstrap based on provider
if [[ "$PROVIDER" == "github" ]]; then
	GITHUB_TOKEN=$(cat "$TOKEN_FILE")
	export GITHUB_TOKEN

	BOOTSTRAP_ARGS=(
		github
		--owner="$OWNER"
		--repository="$REPO"
		--path="$FLUX_PATH"
		--branch=main
	)

	if [[ "$PERSONAL" == true ]]; then
		BOOTSTRAP_ARGS+=(--personal)
	fi

	echo "Bootstrapping FluxCD with GitHub..."
	flux bootstrap "${BOOTSTRAP_ARGS[@]}"
	
	# Post-process YAML files to fix indentation for yamllint compliance
	echo ""
	echo "╔════════════════════════════════════════════════╗"
	echo "║  Reformatting YAML for yamllint compliance    ║"
	echo "╚════════════════════════════════════════════════╝"
	echo ""
	echo "FluxCD generates YAML with 2-space indentation that may not"
	echo "match your repository's yamllint configuration."
	echo ""
	echo "This step will:"
	echo "  1. Clone the repository"
	echo "  2. Reformat YAML files to match standard formatting"
	echo "  3. Commit and push the changes"
	echo ""
	
	# Create temporary directory for reformatting
	TEMP_DIR=$(mktemp -d)
	trap "rm -rf $TEMP_DIR" EXIT
	
	cd "$TEMP_DIR"
	
	# Clone the repository
	echo "Cloning repository..."
	git clone "https://${GITHUB_TOKEN}@github.com/${OWNER}/${REPO}.git" repo
	cd repo
	
	# Configure git
	git config user.name "FluxCD Bootstrap"
	git config user.email "flux@blueberry-k3s.local"
	
	# Find and reformat YAML files (excluding ignored files)
	REFORMATTED=0
	echo ""
	echo "Reformatting YAML files in ${FLUX_PATH}..."
	
	for yaml_file in $(find "${FLUX_PATH}" -type f \( -name "*.yaml" -o -name "*.yml" \) 2>/dev/null); do
		# Skip gotk-components.yaml as it's typically ignored in yamllint configs
		if [[ "$yaml_file" == *"gotk-components.yaml" ]]; then
			echo "  Skipping: $yaml_file (ignored by yamllint)"
			continue
		fi
		
		echo "  Reformatting: $yaml_file"
		
		# Use yq to read and rewrite YAML with proper indentation
		# yq eval with -i flag reformats in-place with correct 2-space indentation
		# and proper sequence handling
		if yq eval -i '.' "$yaml_file" 2>/dev/null; then
			REFORMATTED=$((REFORMATTED + 1))
		else
			echo "    Warning: Failed to reformat $yaml_file"
		fi
	done
	
	# Check if there are changes to commit
	if git diff --quiet; then
		echo ""
		echo "✓ No formatting changes needed - YAML already compliant"
	else
		echo ""
		echo "Committing formatting changes..."
		git add .
		git commit -m "chore: reformat YAML for yamllint compliance

Reformatted Flux-generated YAML files to match repository
yamllint configuration (proper sequence indentation).

This ensures CI validation passes.

Co-authored-by: Copilot <223556219+Copilot@users.noreply.github.com>"
		
		echo "Pushing changes..."
		git push origin main
		
		echo ""
		echo "✓ YAML reformatting complete ($REFORMATTED files processed)"
	fi
	
	cd - > /dev/null

elif [[ "$PROVIDER" == "gitlab" ]]; then
	echo "Error: GitLab provider not yet implemented."
	echo "Contribution welcome!"
	exit 1

elif [[ "$PROVIDER" == "generic" ]]; then
	echo "Error: Generic git provider not yet implemented."
	echo "Contribution welcome!"
	exit 1
fi

echo ""
echo "✓ FluxCD bootstrapped successfully"
echo ""
echo "Check FluxCD status:"
echo "  ujust flux-status"
echo "  flux check"
echo "  kubectl get pods -n flux-system"
echo ""
echo "FluxCD will now continuously reconcile manifests from:"
echo "  $OWNER/$REPO ($FLUX_PATH)"
